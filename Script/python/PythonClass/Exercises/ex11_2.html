<html>
<head>
<title>Python Training Exercises - Exercise 11.2</title>
</head>

<body>
<h1>Exercise 11.2</h1>

<table width=600 bgcolor="#e0e0ff" border=1 cellpadding=20>
<tr>
<td>
<b>Objectives:</b>
<ul>
<li>An example of calling a simple C function from Python.
<li>Use of the ctypes module to access C code without having to use a C compiler.
</ul>
<p>
<b>Files Created:</b> <tt>PythonClass/Ext/cmandel.py</tt>
<p>
<b>Files Modified:</b> <tt>PythonClass/Ext/mandel.py</tt>

</td>
</tr>
</table>

<p>
In the <tt>PythonClass/Ext</tt> directory, you will find a pure-Python script <tt>mandel.py</tt> 
that creates a PNG file with a plot of the famous Mandelbrot set. Open that program with IDLE and
run it now.   You should get output such as this after about 15-30 seconds:

<blockquote>
<pre>
Wrote mandel.png
16.5698359013 seconds
>>>
</pre>
</blockquote>

As output, the program should create a file <tt>PythonClass/Ext/mandel.png</tt>.  If you go into
the <tt>Ext/</tt> directory and double-click on the file, you should see an image such as this:

<p>
<center>
<img src="mandel.png">
</center>

<p>
<b>(a) The Performance Problem</b>

<p>
The script that generates the resulting image is entirely written in
Python. However, almost all of the execution time is consumed by the
following function (in <tt>mandel.py</tt>)

<blockquote>
<pre>
# Test a given x,y coordinate to see if it's a member of the set
def in_mandelbrot(x0,y0,n):
    x = 0
    y = 0
    while n > 0:
        xtemp = x*x - y*y + x0
        y = 2*x*y + y0
        x = xtemp
        n -= 1
        if x*x + y*y > 4: return False
    return True
</pre>
</blockquote>

Try running the <tt>mandel.py</tt> program under the Python profiler.

<blockquote>
<pre>
% <b>python -m cProfile mandel.py</b>
</pre>
</blockquote>

Look at the output and look at the entry for the <tt>in_mandelbrot()</tt> function.

<p>
<b>(b) Using C Functions</b>

<p>
The file <tt>Ext/src/mandel.c</tt> contains a C implementation of the <tt>in_mandelbrot()</tt> function.
Here is what the code looks like this:

<blockquote>
<pre>
/* mandel.c */
/* Test a given x,y coordinate to see if it's a member of the set */
int
in_mandelbrot(double x0, double y0, int n) {
  double x=0,y=0,xtemp;
  while (n > 0) {
    xtemp = x*x - y*y + x0;
    y = 2*x*y + y0;
    x = xtemp;
    n -= 1;
    if (x*x + y*y > 4) return 0;
  }
  return 1;
}
</pre>
</blockquote>

If you take the above C function and compile it into a shared library, the <tt>ctypes</tt> library makes it easy
to access.  The following shared libraries have already been precompiled with the above function:

<blockquote>
<pre>
Ext/win32/libmandel.dll          (Windows)
Ext/osx/libmandel.so             (Macintosh OS-X)
Ext/linux/libmandel.so           (Linux)
</pre>
</blockquote>

Try using ctypes to load the appropriate library depending on what operating system you're using:

<blockquote>
<pre>
>>> <b>import ctypes</b>
>>> <b>ext = ctypes.cdll.LoadLibrary("./win32/libmandel.dll")</b>
>>>
</pre>
</blockquote>

Now, get a reference to the <tt>in_mandelbrot()</tt> function and patch up its argument signatures:

<blockquote>
<pre>
>>> <b>in_mandelbrot = ext.in_mandelbrot</b>
>>> <b>in_mandelbrot.argtypes = (ctypes.c_double, ctypes.c_double, ctypes.c_int)</b>
>>> <b>in_mandelbrot.restype = ctypes.c_int</b>
>>>
</pre>
</blockquote>

Now, try calling the function for a few different values

<blockquote>
<pre>
>>> <b>in_mandelbrot(0,0,500)</b>
1
>>> <b>in_mandelbrot(0.25,0.5,500)</b>
1
>>> <b>in_mandelbrot(2,2,500)</b>
0
>>>
</pre>
</blockquote>

<P>
<b>(c) A Performance Test </b>

<p>
Take the <tt>mandel.py</tt> program and copy it to a new program <tt>cmandel.py</tt>.   Modify the
program so that the <tt>in_mandelbrot()</tt> function is loaded from a C library and used
instead of the Python implementation.

<p>
Run your new program and compare its performance to the pure-Python implementation.   Make sure it
produces the correct output.

<p>
<b>More Information</b>

<p>
Instead of using ctypes, Python also provides a low-level C programming API that allows
extension modules to be directly integrated with this interpreter.   More
information can  be found in the file <tt><a href="../Optional/Extension.pdf">PythonClass/Optional/Extension.pdf</a></tt>.

<p>
<b>Credits</b>

<p>
The PNG output created in this example is being produced by the PyPNG package (<a href="http://code.google.com/p/pypng/">http://code.google.com/p/pypng/</a>).

<hr>
[ <a href="index.html">Index</a> | <a
href="soln11_2.html">Solution</a>
| <a href="ex11_1.html">Back</a> | <a href="sysend.html">Next</a> ]
</body>
</html>
