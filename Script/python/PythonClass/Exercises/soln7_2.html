<html>
<head>
<title>Python Training Exercises</title>
</head>

<body>
<h1>Exercise 7.2 - Solution</h1>

<p>
<b>(a) Adding logging to a module</b>

<pre>
# fieldparse.py

# Get a logger on which to issue diagnostics.  The __name__ variable
# contains the module name--so in this case the logger should have 
# the name 'fieldparse'

import logging
log = logging.getLogger(__name__)

def parse(lines,types,names=None,sep=None):
    '''
    Parse a line of column oriented data into a list of dictionaries
    or tuples with type conversion.
    '''
    records = []
    for lineno, line in enumerate(lines,1):
        # Strip whitespace and ignore blank lines
        line = line.strip()
        if line == '':
            continue

        fields = line.split(sep)
        
        # Get rid of double quotes
        fields = [f.strip('"') for f in fields]
        
        try:
            # Apply type conversion to the fields 
            cfields = [converter(value) for converter,value in zip(types,fields)]
        except ValueError as e:
            log.warning("Line %d: Couldn't parse: %s", lineno, line)
            log.debug("Line %d: Reason %s", lineno, e)
            continue

        # Optionally turn into a dictionary of named fields
        if names is not None:
            record = dict(zip(names,cfields))
        else:
            record = tuple(cfields)

        # Save the record
        records.append(record)

    return records
</pre>

<hr>
<b>(b) Adding Logging to an Application</b>

<pre>
# logconfig.py
#
# This file simply sets up basic configuration of the logging module.
# Change settings here to adjust logging output as needed.

import logging
logging.basicConfig(
    filename = 'app.log',         # Name of the log file
    filemode = 'w',               # File mode (use 'a' to append)
    level    = logging.WARNING,   # Logging level (DEBUG, INFO, WARNING, ERROR, or CRITICAL)
)
</pre>

<p>
Here is the modified report.py:
</p>

<pre>
# report.py

import fieldparse

def read_portfolio(filename):
    '''
    Read a stock portfolio file into a list of dictionaries with keys
    name, shares, and price.
    '''
    return fieldparse.parse(open(filename),[str,int,float],['name','shares','price'])

def read_prices(filename):
    '''
    Read a CSV file of price data into a dict mapping names to prices.
    '''
    return dict(fieldparse.parse(open(filename),[str,float],sep=','))

def make_report(portfolio,prices):
    '''
    Make a list of (name, shares, price, change) tuples given a portfolio list
    and prices dictionary.
    '''
    rows = []
    for stock in portfolio:
        current_price = prices[stock['name']]
        change        = current_price - stock['price']
        summary       = (stock['name'], stock['shares'], current_price, change)
        rows.append(summary)
    return rows

def print_report(reportdata):
    '''
    Print a nicely formated table from a list of (name, shares, price, change) tuples.
    '''
    headers = ('Name','Shares','Price','Change')
    print ("%10s " * len(headers)) % headers
    print ("-"*10 + " ")*len(headers)
    for row in reportdata:
        print "%10s %10d %10.2f %10.2f" % row

def portfolio_report(portfoliofile,pricefile):        
    '''
    Make a stock report given portfolio and price data files.
    '''
    # Read data files 
    portfolio = read_portfolio(portfoliofile)
    prices    = read_prices(pricefile)

    # Create the report data
    report    = make_report(portfolio,prices)

    # Print it out
    print_report(report)

if __name__ == '__main__':
<font color="#0000ff">    import logconfig</font>
    portfolio_report("Data/portfolio.dat",
                     "Data/prices.csv")
</pre>

<hr>
[ <a href="ex7_2.html">Back</a> ]
</body>
</html>
